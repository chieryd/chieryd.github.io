<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="APNs,">










<meta name="description" content="ios10对推送做了很大的优化，我们先来看一下推送展示的逻辑：  如上图所示：在功能上可以划分为四个模块： A: 服务端推送模块 决定推送的内容，以及推送采取的展示方案（展示方案通过category标识）B: NotificationExtensionServie 推送到达时展示预处理模块 这个模块的处理是很快的，目前apple给出的推荐demo中的演示是加载附件中的图片。... 在测试中你会发现">
<meta name="keywords" content="APNs">
<meta property="og:type" content="article">
<meta property="og:title" content="Notification Optimization">
<meta property="og:url" content="http://yoursite.com/2016/11/23/2016-11-23-NotificationOptimization/index.html">
<meta property="og:site_name" content="chiery&#39;blog">
<meta property="og:description" content="ios10对推送做了很大的优化，我们先来看一下推送展示的逻辑：  如上图所示：在功能上可以划分为四个模块： A: 服务端推送模块 决定推送的内容，以及推送采取的展示方案（展示方案通过category标识）B: NotificationExtensionServie 推送到达时展示预处理模块 这个模块的处理是很快的，目前apple给出的推荐demo中的演示是加载附件中的图片。... 在测试中你会发现">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-1.png">
<meta property="og:image" content="http://yoursite.com/images//notificationOptimize-2.png">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-3.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-4.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-5.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-6.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-7.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-9.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-8.jpeg">
<meta property="og:image" content="http://yoursite.com/images/notificationOptimize-10.jpeg">
<meta property="og:updated_time" content="2019-08-07T13:23:58.467Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Notification Optimization">
<meta name="twitter:description" content="ios10对推送做了很大的优化，我们先来看一下推送展示的逻辑：  如上图所示：在功能上可以划分为四个模块： A: 服务端推送模块 决定推送的内容，以及推送采取的展示方案（展示方案通过category标识）B: NotificationExtensionServie 推送到达时展示预处理模块 这个模块的处理是很快的，目前apple给出的推荐demo中的演示是加载附件中的图片。... 在测试中你会发现">
<meta name="twitter:image" content="http://yoursite.com/images/notificationOptimize-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/11/23/2016-11-23-NotificationOptimization/">





  <title>Notification Optimization | chiery'blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chiery'blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-categories"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/2016-11-23-NotificationOptimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chiery'blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Notification Optimization</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-23T16:40:23+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NotificationOptimization/" itemprop="url" rel="index">
                    <span itemprop="name">NotificationOptimization</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ios10对推送做了很大的优化，我们先来看一下推送展示的逻辑：</p>
<p><img src="/images/notificationOptimize-1.png" alt></p>
<p>如上图所示：在功能上可以划分为四个模块：</p>
<p>A: 服务端推送模块</p>
<pre><code>决定推送的内容，以及推送采取的展示方案（展示方案通过category标识）</code></pre><p>B: NotificationExtensionServie 推送到达时展示预处理模块</p>
<pre><code>这个模块的处理是很快的，目前apple给出的推荐demo中的演示是加载附件中的图片。...
在测试中你会发现，一个带有图片的推送到达时做了处理但是没有展示。
但是在第二次推送的时候却展示了。这是因为servieExtension会将已经存在的推送内容直接展示，
需要网络获取的文件有30s的时间可以缓存。所以基本山在第二次推送到达的时候，这个图片已经加载完成，
并缓存了起来</code></pre><p>C: NotificationExtensionContent 推送中间层展开界面的处理</p>
<pre><code>主要根据业务需求，自定义功能界面</code></pre><p>D: Appdelegate.m 注册按钮样式</p>
<pre><code>在UNUserNotification中注册按钮样式，在推送到达后展开推送中间页时使用。</code></pre><a id="more"></a>

<h2 id="开发中遇到的问题"><a href="#开发中遇到的问题" class="headerlink" title="开发中遇到的问题"></a>开发中遇到的问题</h2><p>开发中存在的最大的问题就是按钮样式的问题，每个按钮组合只能通过一个categoryIdentifier来做相应的匹配，导致的问题有：</p>
<ul>
<li>每个业务都需要存在一个按钮样式的组合identifier。</li>
<li>每个identifier在注册后按钮样式不能动态变更</li>
</ul>
<p>同时，由于注册按钮时机的关系（按钮组合样式的注册是在Appdelegate.m文件中注册的），导致的问题有：</p>
<ul>
<li>每个按钮的功能也是事先决定好了的，导致了按钮的灵活度降低。</li>
<li>业务线开发必须通过更改公共代码来注册按钮，增加了功能耦合</li>
</ul>
<p>当时是整个框架带着这些诟病一起上线了，实在是个不治之举。这个问题之前一直没有解决，XcodeBeta版本中验证了很多方案也是没有成功，包括下面的方案。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>最近又开始对这一问题做了详细的跟踪，终于找到了一个满意的解决方案。这里先看图：</p>
<p><img src="/images//notificationOptimize-2.png" alt></p>
<p>产生的构思来自于这个图片，将UNUserNotificationCenter看成独立于App和AppExtension之外的独立结构，所有的app注册category都是向这个结构中添加按钮样式。那么问题就来了，可不可以不在appdelegate.m中注册信息，将category的注册放到extensionServie中，答案是可以的。</p>
<p>这里其实应该是有几个疑问的？</p>
<p>1： servie中注册和app中注册有区别？能生效？</p>
<p>2： 重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？</p>
<p>3： 每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？</p>
<p>答案是这样的：</p>
<h4 id="servie中注册和app中注册有区别？能生效？"><a href="#servie中注册和app中注册有区别？能生效？" class="headerlink" title="servie中注册和app中注册有区别？能生效？"></a>servie中注册和app中注册有区别？能生效？</h4><p>servie中注册和app中注册没有却别，能生效</p>
<h4 id="重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？"><a href="#重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？" class="headerlink" title="重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？"></a>重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？</h4><p>重复注册同一个categoryIdentifier会将原先的覆盖，这样就可以实现同一个categoryIdentifier变更按钮样式的需求了。下图是发出同一个categoryIdentifier推送后，打印的日志</p>
<p>ExtensionServie中实现的打印代码</p>
<pre><code>@interface
[[UNUserNotificationCenter currentNotificationCenter] getNotificationCategoriesWithCompletionHandler:^(NSSet&lt;UNNotificationCategory *&gt; * _Nonnull categories) {
    NSLog(@&quot;这里打印的是category的信息&quot;);
    NSLog(@&quot;%@&quot;,categories);
}];
@end</code></pre><p>这是推送payload，这里payload标记位payloadOld</p>
<pre><code>{
    &quot;aps&quot;:{
        &quot;collapse&quot;:&quot;testKey&quot;,
        &quot;alert&quot;:{
            &quot;title&quot;: &quot;支付提醒&quot;,
            &quot;body&quot;: &quot;您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您&quot;,
        },
        &quot;mutable-content&quot;: 1,
        &quot;sound&quot;:&quot;default&quot;,
        &quot;badge&quot;:1,
        &quot;category&quot;:&quot;MyZoneNotification&quot;,
    },
    &quot;actions&quot;:[
        {
            &quot;actionType&quot;:0,
            &quot;actionTitle&quot;:&quot;查看详情***====&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;checkInfo&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        },
        {
            &quot;actionType&quot;:1,
            &quot;actionTitle&quot;:&quot;回复***====&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;applyInfo&quot;,
            &quot;textInputButtonTitle&quot;:&quot;回复的按钮&quot;,
            &quot;textInputPlaceholder&quot;:&quot;输入你想回复的内容&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        }
    ]
}</code></pre><p>这是发送了一个推送后的日志</p>
<pre><code>2016-11-23 11:50:03.345871 RemoteNotificationTestServie[2073:191810] 这里打印的是category的信息
2016-11-23 11:50:03.346584 RemoteNotificationTestServie[2073:191810] {(
    &lt;UNNotificationCategory: 0x127d27090; identifier: MyZoneNotification, actions: (
    &quot;&lt;UNNotificationAction: 0x127d3bd20; identifier: checkInfo, title: \U67e5\U770b\U8be6\U60c5****====, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO&gt;&quot;,
    &quot;&lt;UNTextInputNotificationAction: 0x127d396b0; identifier: applyInfo, title: \U56de\U590d***====, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO, textInputButtonTitle: \U56de\U590d\U7684\U6309\U94ae, textInputPlaceholder: \U8f93\U5165\U4f60\U60f3\U56de\U590d\U7684\U5185\U5bb9&gt;&quot;
), minimalAction: (
), intentIdentifiers: (
    check
), custom dismiss: NO, CarPlay: NO&gt;
)}</code></pre><p>更改了之后的payload actionTitle更改了，actionIdentifier更改了。这里payload标记位payloadNew</p>
<pre><code>{
    &quot;aps&quot;:{
        &quot;collapse&quot;:&quot;testKey&quot;,
        &quot;alert&quot;:{
            &quot;title&quot;: &quot;支付提醒&quot;,
            &quot;body&quot;: &quot;您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您&quot;,
        },
        &quot;mutable-content&quot;: 1,
        &quot;sound&quot;:&quot;default&quot;,
        &quot;badge&quot;:1,
        &quot;category&quot;:&quot;MyZoneNotification&quot;,
    },
    &quot;actions&quot;:[
        {
            &quot;actionType&quot;:0,
            &quot;actionTitle&quot;:&quot;查看详情&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;checkInfo***&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        },
        {
            &quot;actionType&quot;:1,
            &quot;actionTitle&quot;:&quot;回复&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;applyInfo====&quot;,
            &quot;textInputButtonTitle&quot;:&quot;回复的按钮&quot;,
            &quot;textInputPlaceholder&quot;:&quot;输入你想回复的内容&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        }
    ]
}</code></pre><p>更改了payload中的action之后日志</p>
<pre><code>2016-11-23 11:52:44.074709 RemoteNotificationTestServie[2073:192382] 这里打印的是category的信息
2016-11-23 11:52:44.076397 RemoteNotificationTestServie[2073:192382] {(
    &lt;UNNotificationCategory: 0x127d26a10; identifier: MyZoneNotification, actions: (
    &quot;&lt;UNNotificationAction: 0x127d245f0; identifier: checkInfo***, title: \U67e5\U770b\U8be6\U60c5, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO&gt;&quot;,
    &quot;&lt;UNTextInputNotificationAction: 0x127d265a0; identifier: applyInfo====, title: \U56de\U590d, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO, textInputButtonTitle: \U56de\U590d\U7684\U6309\U94ae, textInputPlaceholder: \U8f93\U5165\U4f60\U60f3\U56de\U590d\U7684\U5185\U5bb9&gt;&quot;
), minimalAction: (
), intentIdentifiers: (
    check
), custom dismiss: NO, CarPlay: NO&gt;
)}

actionIdentifier已经变了</code></pre><h4 id="对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的："><a href="#对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的：" class="headerlink" title="对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的："></a>对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的：</h4><ul>
<li>发出5条payloadOld,</li>
<li>发出5条payloadNew</li>
<li>点击查看效果</li>
</ul>
<p>从日志分析可以得出理论结论，无论点击展开新的覆盖的推送还是点击以前较为旧的推送，都应该展示最新的推送的按钮的样式。但是实际结果是这样的</p>
<p><img src="/images/notificationOptimize-3.jpeg" alt><img src="/images/notificationOptimize-4.jpeg" alt><img src="/images/notificationOptimize-5.jpeg" alt><img src="/images/notificationOptimize-6.jpeg" alt><img src="/images/notificationOptimize-7.jpeg" alt></p>
<p>这个结论与日志打印得出的理论结论不相同，覆盖了之后的category按钮样式应该只有一个啊，之前的按钮难道还在缓存中没有释放？。试想了两种情况解决：</p>
<ul>
<li>等待足够长时间，等待之前action缓存释放</li>
<li>重启手机</li>
</ul>
<p>答案是可以的，在等待了2分钟时长时打开payloadOld的推送，发现按钮样式已经是最新的了。重启手机可以打开payloadOld立即就是最新的了。</p>
<h4 id="测试版本"><a href="#测试版本" class="headerlink" title="测试版本"></a>测试版本</h4><p>目前测试的手机的系统是ios10.2 beta3. Xcode是8.2beta3。需要在release ios10.1.1上再做一次验证</p>
<p>经测试再已经发布的系统版本中测试版本ios10.1同样存在这样的问题. Xcode8.1 release,ios10.1 release。</p>
<h4 id="每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？"><a href="#每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？" class="headerlink" title="每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？"></a>每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？</h4><ul>
<li>发出五个不同的category，每个category携带不同的样式</li>
<li>日志打印UNUserNotificationCenter中的category个数以及信息</li>
</ul>
<p>这里先展示一下推送中注册category的方法</p>
<pre><code>@interface
- (void)registerCategory:(NSDictionary *)userInfo {
    NSParameterAssert(userInfo);
    NSString *categoryIdentifier = userInfo[@&quot;aps&quot;][@&quot;category&quot;];
    NSMutableArray *tempArray = [NSMutableArray new];
    NSArray *actions = userInfo[@&quot;actions&quot;];
    if (actions.count) {
        for (NSDictionary *action in actions) {
            if ([action[actionType] integerValue] == 0) {
                UNNotificationAction *tempAction = [self buildNotificationAction:action];
                if (tempAction) [tempArray addObject:tempAction];
            }else {
                UNTextInputNotificationAction *tempAction = [self buildTextNotification:action];
                if (tempAction) [tempArray addObject:tempAction];
            }
        }
    }
    if (tempArray.count &gt; 0) {
        NSMutableSet *set = [NSMutableSet new];
        UNNotificationCategory *category = [UNNotificationCategory categoryWithIdentifier:categoryIdentifier actions:[tempArray copy] intentIdentifiers:@[@&quot;check&quot;] options:UNNotificationCategoryOptionNone];
        [set addObject:category];
        [[UNUserNotificationCenter currentNotificationCenter] setNotificationCategories:set];
    }
}
@end</code></pre><p>这个方法是之前的实现，使用这个方法注册。发现当这个新的category推送到达的时候，都会将之前的酒店推送给冲掉，换句话说。推送中心中只能存在最新的推送的category，看了一下api的描述，发现问题所在：<code>setNotificationCategories</code>相当于重置category。所以在推送中心中只能存在最新的推送的样式，针对这个问题有如下两个解决办法：</p>
<ul>
<li>每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册。</li>
<li>payload中每次只带这个业务的推送的category。</li>
</ul>
<h4 id="每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册"><a href="#每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册" class="headerlink" title="每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册"></a>每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册</h4><p>这个方案下需要考虑的问题是，注册数据的来源是：</p>
<ul>
<li>payload</li>
<li>NotificationServieExtension下载</li>
</ul>
<p>如果使用payload将注册的按钮信息带过来的话，会增加payload的size,ios8之后payload的size要求是在4kb之内。还有一个问题，每次将这么庞大的（相对来说注册Category的信息过于庞大）payload作为推送发出来也是不合理的，会增加用户的流量开销。</p>
<p>如果使用NotificationServieExtension下载的方式如何，那就需要设计一套比较好的方案了，这个接口有很大的安全风险，毕竟action还是可以对app发出相应的操作的，所以需要做安全校验。可以开辟两个后台的接口，一个用于检测更新，一个用于存放推送的category内容。标识符可以是版本号和categoryID来做更新，当用户检测到新的category时，下载最新的资源并注册，将资源存在本地。这么做存在的问题是，可能推送成功，但是没有成功的下载推送文件，注册category没有成功，导致按钮样式没有显示。</p>
<h4 id="payload中每次只带这个业务的推送的category"><a href="#payload中每次只带这个业务的推送的category" class="headerlink" title="payload中每次只带这个业务的推送的category"></a>payload中每次只带这个业务的推送的category</h4><p>这个也是很简单的，将代码重新改为这样就好了，对于推送本体来说不论添加还是覆盖，都不应该存在相同的categoryIdentifier,所以需要先检测当前UNUserNotification中的所有的category，如果这个category存在则删除后增加，如果不存在直接增加</p>
<p>代码如下：</p>
<pre><code>@interface
- (void)registerCategory:(NSDictionary *)userInfo {
    NSParameterAssert(userInfo);
    NSString *categoryIdentifier = userInfo[@&quot;aps&quot;][@&quot;category&quot;];
    NSMutableArray *tempArray = [NSMutableArray new];
    NSArray *actions = userInfo[@&quot;actions&quot;];
    if (actions.count) {
        for (NSDictionary *action in actions) {
            if ([action[actionType] integerValue] == 0) {
                UNNotificationAction *tempAction = [self buildNotificationAction:action];
                if (tempAction) [tempArray addObject:tempAction];
            }else {
                UNTextInputNotificationAction *tempAction = [self buildTextNotification:action];
                if (tempAction) [tempArray addObject:tempAction];
            }
        }
    }
    if (tempArray.count &gt; 0) {
        [[UNUserNotificationCenter currentNotificationCenter] getNotificationCategoriesWithCompletionHandler:^(NSSet&lt;UNNotificationCategory *&gt; * _Nonnull categories) {
            NSMutableSet *set = [categories mutableCopy];
            for (NSInteger i = 0; i &lt; set.allObjects.count; i ++) {
                UNNotificationCategory *category = set.allObjects[i];
                if ([category.identifier isEqualToString:categoryIdentifier]) {
                    [set removeObject:category];
                    break;
                }

            }
            UNNotificationCategory *category = [UNNotificationCategory categoryWithIdentifier:categoryIdentifier actions:[tempArray copy] intentIdentifiers:@[@&quot;check&quot;] options:UNNotificationCategoryOptionNone];
            [set addObject:category];
            [[UNUserNotificationCenter currentNotificationCenter] setNotificationCategories:set];
        }];
    }
}
@end</code></pre><p>在注册的时候将以前存在的category全部复制过来，检测有没有重复的，有则删除，没有则增加即可。再看一下日志打印结果：</p>
<pre><code>2016-11-23 16:21:01.357154 RemoteNotificationTestServie[979:60218] {(
    &lt;UNNotificationCategory: 0x111d0b060; identifier: MyZoneNotification1, actions: (
    &quot;&lt;UNNotificationAction: 0x111d11ca0; identifier: checkInfo1, title: \U67e5\U770b\U8be6\U60c51, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO&gt;&quot;,
    &quot;&lt;UNTextInputNotificationAction: 0x111d07b20; identifier: applyInfo, title: \U56de\U590d1, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO, textInputButtonTitle: \U56de\U590d\U7684\U6309\U94ae, textInputPlaceholder: \U8f93\U5165\U4f60\U60f3\U56de\U590d\U7684\U5185\U5bb9&gt;&quot;
), minimalAction: (
), intentIdentifiers: (
    check
), custom dismiss: NO, CarPlay: NO&gt;,
    &lt;UNNotificationCategory: 0x111d09cf0; identifier: MyZoneNotification2, actions: (
    &quot;&lt;UNNotificationAction: 0x111d09d20; identifier: checkInfo2, title: \U67e5\U770b\U8be6\U60c52, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO&gt;&quot;,
    &quot;&lt;UNTextInputNotificationAction: 0x111d0b7a0; identifier: applyInfo, title: \U56de\U590d2, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO, textInputButtonTitle: \U56de\U590d\U7684\U6309\U94ae, textInputPlaceholder: \U8f93\U5165\U4f60\U60f3\U56de\U590d\U7684\U5185\U5bb9&gt;&quot;
), minimalAction: (
), intentIdentifiers: (
    check
), custom dismiss: NO, CarPlay: NO&gt;,
    &lt;UNNotificationCategory: 0x111d0ebf0; identifier: MyZoneNotification3, actions: (
    &quot;&lt;UNNotificationAction: 0x111d0f500; identifier: checkInfo3, title: \U67e5\U770b\U8be6\U60c53, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO&gt;&quot;,
    &quot;&lt;UNTextInputNotificationAction: 0x111d144e0; identifier: applyInfo, title: \U56de\U590d3, isAuthenticationRequired: NO, isDestructive: NO, isForeground: NO, textInputButtonTitle: \U56de\U590d\U7684\U6309\U94ae, textInputPlaceholder: \U8f93\U5165\U4f60\U60f3\U56de\U590d\U7684\U5185\U5bb9&gt;&quot;
), minimalAction: (
), intentIdentifiers: (
    check
), custom dismiss: NO, CarPlay: NO&gt;
)}</code></pre><p>这样就会存在三个category的注册了，推送中也能匹配到三个不同的按钮样式了</p>
<p><img src="/images/notificationOptimize-9.jpeg" alt><img src="/images/notificationOptimize-8.jpeg" alt><img src="/images/notificationOptimize-10.jpeg" alt></p>
<p>但是这种方式的好处是业务线可以自己管理自己的推送的样式，与公共模块解耦，但是同样存在弊端，例如一个IM类应用，如果频繁的发出这样的推送，携带这样的资源就没有必要了</p>
<h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ul>
<li>推送消息不是很频繁的情况可以使用第二种方案（payload中每次只带这个业务的推送的category）。可以减少接口开发，契合业务需求。</li>
<li>推送消息很频繁的情况可以使用第一种方案的第二个小方案（NotificationServieExtension下载），减少payload内容数量，较少用户流量消耗</li>
<li>在任何情况下不建议使用第一种方案的第一个消防安全，存在的弊端太大</li>
</ul>
<h2 id="代码展示"><a href="#代码展示" class="headerlink" title="代码展示"></a>代码展示</h2><p>如下是NotificationServie中的实现</p>
<pre><code>#import &quot;NotificationService.h&quot;
NSString *const actionTitle = @&quot;actionTitle&quot;;
NSString *const actionType = @&quot;actionType&quot;;
NSString *const actionOptions = @&quot;actionOptions&quot;;
NSString *const actionIdentifier = @&quot;actionIdentifier&quot;;
NSString *const textInputButtonTitle = @&quot;textInputButtonTitle&quot;;
NSString *const textInputPlaceholder = @&quot;textInputPlaceholder&quot;;
NSString *const actionScheme = @&quot;actionScheme&quot;;

@interface NotificationService ()
@property (nonatomic, strong) void (^contentHandler)(UNNotificationContent *contentToDeliver);
@property (nonatomic, strong) UNMutableNotificationContent *bestAttemptContent;
@property (nonatomic, strong) NSDictionary *userInfo;
@end

@implementation NotificationService

- (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent * _Nonnull))contentHandler {
    self.userInfo = request.content.userInfo;
    [self registerCategory:self.userInfo];

    [[UNUserNotificationCenter currentNotificationCenter] getNotificationCategoriesWithCompletionHandler:^(NSSet&lt;UNNotificationCategory *&gt; * _Nonnull categories) {
        NSLog(@&quot;这里打印的是category的信息&quot;);
        NSLog(@&quot;%@&quot;,categories);
    }];
    self.contentHandler = contentHandler;
    self.bestAttemptContent = [request.content mutableCopy];

    // Modify the notification content here...
    self.bestAttemptContent.title = [NSString stringWithFormat:@&quot;%@ [modified]&quot;, self.bestAttemptContent.title];

    self.contentHandler(self.bestAttemptContent);
}

- (void)serviceExtensionTimeWillExpire {
    [self registerCategory:self.userInfo];
    self.contentHandler(self.bestAttemptContent);
}

- (void)registerCategory:(NSDictionary *)userInfo {
    NSParameterAssert(userInfo);
    NSString *categoryIdentifier = userInfo[@&quot;aps&quot;][@&quot;category&quot;];
    NSMutableArray *tempArray = [NSMutableArray new];
    NSArray *actions = userInfo[@&quot;actions&quot;];
    if (actions.count) {
        for (NSDictionary *action in actions) {
            if ([action[actionType] integerValue] == 0) {
                UNNotificationAction *tempAction = [self buildNotificationAction:action];
                if (tempAction) [tempArray addObject:tempAction];
            }else {
                UNTextInputNotificationAction *tempAction = [self buildTextNotification:action];
                if (tempAction) [tempArray addObject:tempAction];
            }
        }
    }
    if (tempArray.count &gt; 0) {
        [[UNUserNotificationCenter currentNotificationCenter] getNotificationCategoriesWithCompletionHandler:^(NSSet&lt;UNNotificationCategory *&gt; * _Nonnull categories) {
            NSMutableSet *set = [categories mutableCopy];
            for (NSInteger i = 0; i &lt; set.allObjects.count; i ++) {
                UNNotificationCategory *category = set.allObjects[i];
                if ([category.identifier isEqualToString:categoryIdentifier]) {
                    [set removeObject:category];
                    break;
                }

            }
            UNNotificationCategory *category = [UNNotificationCategory categoryWithIdentifier:categoryIdentifier actions:[tempArray copy] intentIdentifiers:@[@&quot;check&quot;] options:UNNotificationCategoryOptionNone];
            [set addObject:category];
            [[UNUserNotificationCenter currentNotificationCenter] setNotificationCategories:set];
        }];
    }
}

- (UNNotificationAction *)buildNotificationAction:(NSDictionary *)action {
    NSParameterAssert(action);
    NSString *title = action[actionTitle];
    NSString *identifier = action[actionIdentifier];
    NSString *optionsString = action[actionOptions];

    UNNotificationActionOptions options;
    if ([optionsString isEqualToString:@&quot;acptions&quot;]) {
        options = UNNotificationActionOptionForeground;
    }
    return [UNNotificationAction actionWithIdentifier:identifier title:title options:options];
}

- (UNTextInputNotificationAction *)buildTextNotification:(NSDictionary *)action {
    NSParameterAssert(action);

    NSString *title = action[actionTitle];
    NSString *identifier = action[actionIdentifier];
    NSString *buttonTitle = action[textInputButtonTitle];
    NSString *placeholder = action[textInputPlaceholder];

    NSString *optionsString = action[actionOptions];

    UNNotificationActionOptions options;
    if ([optionsString isEqualToString:@&quot;acptions&quot;]) {
        options = UNNotificationActionOptionForeground;
    }
    return [UNTextInputNotificationAction actionWithIdentifier:identifier title:title options:options textInputButtonTitle:buttonTitle textInputPlaceholder:placeholder];
}

@end</code></pre><p>payload Example:</p>
<pre><code>{
    &quot;aps&quot;:{
        &quot;alert&quot;:{
            &quot;title&quot;: &quot;支付提醒&quot;,
            &quot;body&quot;: &quot;您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您预订的艾丽华酒店您&quot;,
        },
        &quot;mutable-content&quot;: 1,
        &quot;sound&quot;:&quot;default&quot;,
        &quot;badge&quot;:1,
        &quot;category&quot;:&quot;MyZoneNotification&quot;,
        &quot;collapse&quot;:&quot;testKey&quot;
    },
    &quot;actions&quot;:[
        {
            &quot;actionType&quot;:0,
            &quot;actionTitle&quot;:&quot;查看详情****====&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;checkInfo&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        },
        {
            &quot;actionType&quot;:1,
            &quot;actionTitle&quot;:&quot;回复***====&quot;,
            &quot;actionOptions&quot;:&quot;foreground&quot;,
            &quot;actionIdentifier&quot;:&quot;applyInfo&quot;,
            &quot;textInputButtonTitle&quot;:&quot;回复的按钮&quot;,
            &quot;textInputPlaceholder&quot;:&quot;输入你想回复的内容&quot;,
            &quot;actionScheme&quot;:&quot;******&quot;,
        }
    ]
}</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在NotificationServieExtension中注册Category能带来什么？首选我们来看一下在appdelegate.m中注册category会有什么弊端：</p>
<ul>
<li>不能实时更新，需要发版才能更新</li>
<li>业务代码与公共功能耦合。</li>
</ul>
<p>在NotificationServieExtension中注册的优势</p>
<ul>
<li>实时变更按钮样式。覆盖指定categoryIdentifier的按钮样式组合</li>
<li>业务功能与公共组件解耦。通过payload带来的信息，实时注册按钮。</li>
<li>实时变更按钮的功能。按钮的功能也可以通过payload载体携带</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/APNs/" rel="tag"># APNs</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/11/2016-11-11-宫崎骏作品/" rel="next" title="宫崎骏作品年表">
                <i class="fa fa-chevron-left"></i> 宫崎骏作品年表
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/23/2017-02-23-基于标记的AR/" rel="prev" title="基于标记的AR">
                基于标记的AR <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description">持续、专注</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#开发中遇到的问题"><span class="nav-number">1.</span> <span class="nav-text">开发中遇到的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决方案"><span class="nav-number">2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#servie中注册和app中注册有区别？能生效？"><span class="nav-number">2.0.1.</span> <span class="nav-text">servie中注册和app中注册有区别？能生效？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？"><span class="nav-number">2.0.2.</span> <span class="nav-text">重复注册同一个categoryIdentifier会如何？之前发出的推动展示的按钮样式是先前的还是更改之后的？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的："><span class="nav-number">2.0.3.</span> <span class="nav-text">对于之前发出的推动展示的按钮样式是先前的还是更改之后的？这个问题是这样测试的：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试版本"><span class="nav-number">2.0.4.</span> <span class="nav-text">测试版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？"><span class="nav-number">2.0.5.</span> <span class="nav-text">每次注册一个categoryIdentifier，那么之前的推送的组合样式还存在？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册"><span class="nav-number">2.0.6.</span> <span class="nav-text">每次推送达到的时候，将推送所需的所有注册方案都传递过来，一并注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#payload中每次只带这个业务的推送的category"><span class="nav-number">2.0.7.</span> <span class="nav-text">payload中每次只带这个业务的推送的category</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建议"><span class="nav-number">2.1.</span> <span class="nav-text">建议</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#代码展示"><span class="nav-number">3.</span> <span class="nav-text">代码展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
